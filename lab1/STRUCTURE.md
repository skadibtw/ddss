# Структура проекта

```
lab1/
├── README.md                    # Краткое руководство пользователя
├── REPORT.md                    # Подробный отчет по лабораторной работе
├── .gitignore                   # Исключения для Git
│
├── config/                      # Конфигурационные файлы
│   ├── postgresql.conf          # Конфигурация сервера PostgreSQL
│   └── pg_hba.conf             # Конфигурация аутентификации и доступа
│
└── scripts/                     # Исполняемые скрипты
    ├── init.sh                  # Инициализация кластера PostgreSQL
    ├── config.sql               # Создание базы данных и ролей
    ├── table_spaces.sql         # Создание табличных пространств
    ├── create.sql               # Создание структуры таблиц
    ├── seeds.sql                # Наполнение данными
    ├── info.sql                 # Вывод информации о табличных пространствах
    ├── setup_all.sh             # Автоматическая установка всего
    ├── status.sh                # Проверка состояния кластера
    └── clean.sh                 # Полная очистка (удаление всего)
```

## Описание файлов

### Документация

- **README.md** - Краткое руководство по использованию с основными командами
- **REPORT.md** - Полный отчет для сдачи лабораторной работы со всеми командами и конфигурациями
- **STRUCTURE.md** - Этот файл, описание структуры проекта

### Конфигурационные файлы (config/)

- **postgresql.conf** - Главный конфигурационный файл PostgreSQL с настройками для OLTP
  - Параметры памяти (shared_buffers, work_mem, etc.)
  - Настройки WAL и контрольных точек
  - Параметры логирования
  - Настройки для High Availability

- **pg_hba.conf** - Конфигурация методов аутентификации клиентов
  - Unix-domain socket (peer)
  - TCP/IP localhost (scram-sha-256)
  - Запрет всех остальных подключений

### Скрипты (scripts/)

#### Основные скрипты установки (выполнять по порядку)

1. **init.sh** - Инициализация кластера
   - Создает кластер PostgreSQL в $HOME/nwc36
   - Устанавливает кодировку UTF8 и русскую локаль
   - Копирует конфигурационные файлы
   - Создает необходимые директории

2. **config.sql** - Настройка базы данных
   - Создает базу данных bigbluecity
   - Создает роль dbuser
   - Предоставляет необходимые права

3. **table_spaces.sql** - Создание табличных пространств
   - Создает табличное пространство sbm10_space
   - Создает табличное пространство nym69_space
   - Предоставляет права роли dbuser

4. **create.sql** - Создание структуры
   - Создает партицированную таблицу sales (4 партиции)
   - Создает таблицы customers, products, stores
   - Создает индексы в разных табличных пространствах
   - Создает материализованное представление sales_summary
   - Создает представление sales_analytics

5. **seeds.sql** - Наполнение данными
   - Добавляет 12 клиентов
   - Добавляет 15 товаров
   - Добавляет 5 магазинов
   - Генерирует 10,000 записей о продажах
   - Обновляет материализованное представление

#### Вспомогательные скрипты

- **setup_all.sh** - Автоматическая установка всего сразу
  - Последовательно выполняет все этапы установки
  - Удобен для быстрого развертывания
  - Требует минимальной ручной настройки

- **status.sh** - Проверка состояния
  - Проверяет статус сервера
  - Показывает информацию о базах данных
  - Проверяет существование роли и табличных пространств
  - Показывает активные подключения
  - Выводит последние строки логов

- **info.sql** - Информация о табличных пространствах
  - Список всех табличных пространств с размерами
  - Объекты по табличным пространствам
  - Детальная статистика по партициям
  - Распределение объектов по типам

- **clean.sh** - Полная очистка
  - Останавливает сервер
  - Удаляет кластер PostgreSQL
  - Удаляет табличные пространства
  - Удаляет архив WAL
  - **ВНИМАНИЕ**: Удаляет ВСЕ данные!

## Порядок использования

### Первичная установка

```bash
# Вариант 1: Автоматическая установка
./scripts/setup_all.sh

# Вариант 2: Пошаговая установка
./scripts/init.sh
pg_ctl -D $HOME/nwc36 -l $HOME/nwc36/logfile start
psql -p 9099 -d postgres -f scripts/config.sql

# ВАЖНО: Перед следующим шагом отредактируйте scripts/table_spaces.sql
# Замените :HOME на полный путь, например: /home/postgres1

psql -p 9099 -d postgres -f scripts/table_spaces.sql
PGPASSWORD="secure_password_123" psql -p 9099 -h localhost -U dbuser -d bigbluecity -f scripts/create.sql
PGPASSWORD="secure_password_123" psql -p 9099 -h localhost -U dbuser -d bigbluecity -f scripts/seeds.sql
```

### Проверка состояния

```bash
./scripts/status.sh
```

### Просмотр информации о табличных пространствах

```bash
psql -p 9099 -h localhost -U dbuser -d bigbluecity -f scripts/info.sql
```

### Полная очистка (для переустановки)

```bash
./scripts/clean.sh
```

## Требования

- PostgreSQL 12 или выше
- Bash
- Минимум 1GB свободного места на диске
- Локаль ru_RU.UTF-8 должна быть установлена в системе

## Параметры варианта

- Директория кластера: `$HOME/nwc36`
- Порт: `9099`
- Табличные пространства: `$HOME/sbm10`, `$HOME/nym69`
- База данных: `bigbluecity`
- Роль: `dbuser` / `secure_password_123`
- Сценарий: OLTP (1500 tps, 24KB, High Availability)

## Контакты

По вопросам выполнения лабораторной работы обращайтесь к преподавателю.
