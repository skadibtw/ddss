# ============================================
# PostgreSQL Configuration File
# Настройки для OLTP сценария (1500 tps, 24KB, HA)
# Порт: 9099
# ============================================

# -----------------------------
# СОЕДИНЕНИЯ И АУТЕНТИФИКАЦИЯ
# -----------------------------

# Порт подключения
port = 9099

# Прослушивание только localhost
listen_addresses = 'localhost'

# Директория Unix-domain сокетов
unix_socket_directories = '/tmp'

# Максимум подключений
max_connections = 200

# Резервные подключения для суперпользователя
superuser_reserved_connections = 3


# -----------------------------
# ПАРАМЕТРЫ ПАМЯТИ
# -----------------------------

# Разделяемая память (25% от RAM)
# Для OLTP рекомендуется 25% от доступной памяти
shared_buffers = 2GB

# Временные буферы для каждой сессии
temp_buffers = 32MB

# Память для операций сортировки/join
# Для OLTP меньше, чем для OLAP
work_mem = 8MB

# Память для maintenance операций (VACUUM, CREATE INDEX)
maintenance_work_mem = 512MB

# Эффективный размер кеша (50-75% RAM)
effective_cache_size = 6GB

# Максимум стека глубины выражений
max_stack_depth = 2MB


# -----------------------------
# WAL (Write Ahead Log)
# -----------------------------

# Уровень WAL (для репликации)
wal_level = replica

# Включить fsync для надежности данных
fsync = on

# Метод синхронизации
synchronous_commit = on

# Размеры WAL
min_wal_size = 1GB
max_wal_size = 4GB

# WAL буферы (по умолчанию -1 = автоматически, 1/32 от shared_buffers)
wal_buffers = -1

# Задержка коммита для группировки записей
commit_delay = 10

# Минимум параллельных транзакций для применения commit_delay
commit_siblings = 5

# WAL writer delay
wal_writer_delay = 200ms


# -----------------------------
# КОНТРОЛЬНЫЕ ТОЧКИ
# -----------------------------

# Интервал контрольных точек
checkpoint_timeout = 10min

# Цель завершения контрольной точки (90% от timeout)
checkpoint_completion_target = 0.9

# Предупреждение если checkpoint чаще чем это значение
checkpoint_warning = 5min


# -----------------------------
# АРХИВИРОВАНИЕ (для HA)
# -----------------------------

# Включить архивирование
archive_mode = on

# Команда архивирования
# ВАЖНО: создайте директорию /tmp/archive перед запуском
archive_command = 'test ! -f /tmp/archive/%f && cp %p /tmp/archive/%f'

# Таймаут архивирования
archive_timeout = 300


# -----------------------------
# РЕПЛИКАЦИЯ
# -----------------------------

# Количество WAL sender процессов
max_wal_senders = 5

# Количество слотов репликации
max_replication_slots = 5

# Сохранять WAL для standby
wal_keep_size = 1GB


# -----------------------------
# ПАРАЛЛЕЛИЗМ
# -----------------------------

# Максимум worker процессов
max_worker_processes = 8

# Максимум параллельных workers
max_parallel_workers = 8

# Параллельные workers на операцию
max_parallel_workers_per_gather = 2

# Параллельные maintenance workers
max_parallel_maintenance_workers = 2


# -----------------------------
# СТАТИСТИКА И МОНИТОРИНГ
# -----------------------------

# Расширения для загрузки при старте
shared_preload_libraries = 'pg_stat_statements'

# Параметры pg_stat_statements
pg_stat_statements.max = 10000
pg_stat_statements.track = all


# -----------------------------
# ЛОГИРОВАНИЕ
# -----------------------------

# Куда писать логи
log_destination = 'stderr'

# Включить сборщик логов
logging_collector = on

# Директория логов (относительно PGDATA)
log_directory = 'log'

# Формат имени файла лога
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'

# Ротация по времени
log_rotation_age = 1d

# Ротация по размеру
log_rotation_size = 100MB

# Не обрезать логи при ротации
log_truncate_on_rotation = off

# Минимальный уровень сообщений в логе
log_min_messages = notice

# Минимальный уровень для ERROR
log_min_error_statement = error

# Логировать подключения
log_connections = on

# Логировать отключения
log_disconnections = on

# Логировать длительность сессий
log_duration = off

# Логировать запросы длиннее указанного времени
log_min_duration_statement = 1000

# Префикс строки лога
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# Временная зона для логов
log_timezone = 'Europe/Moscow'


# -----------------------------
# AUTOVACUUM
# -----------------------------

# Включить autovacuum
autovacuum = on

# Задержка между запусками (для OLTP меньше)
autovacuum_naptime = 1min

# Максимум параллельных autovacuum workers
autovacuum_max_workers = 3

# Порог для запуска VACUUM
autovacuum_vacuum_threshold = 50
autovacuum_vacuum_scale_factor = 0.1

# Порог для запуска ANALYZE
autovacuum_analyze_threshold = 50
autovacuum_analyze_scale_factor = 0.05


# -----------------------------
# ЛОКАЛИ И ФОРМАТИРОВАНИЕ
# -----------------------------

# Временная зона по умолчанию
timezone = 'Europe/Moscow'

# Локаль для сообщений
lc_messages = 'ru_RU.UTF-8'

# Локаль для денежных значений
lc_monetary = 'ru_RU.UTF-8'

# Локаль для числовых значений
lc_numeric = 'ru_RU.UTF-8'

# Локаль для времени
lc_time = 'ru_RU.UTF-8'

# Кодировка по умолчанию для клиентов
client_encoding = UTF8


# -----------------------------
# ОПТИМИЗАТОР ЗАПРОСОВ
# -----------------------------

# Стоимость последовательного чтения страницы
seq_page_cost = 1.0

# Стоимость случайного чтения страницы
# Для SSD можно уменьшить до 1.1-1.5
random_page_cost = 4.0

# Стоимость обработки строки CPU
cpu_tuple_cost = 0.01

# Стоимость обработки индекса CPU
cpu_index_tuple_cost = 0.005

# Стоимость операции CPU
cpu_operator_cost = 0.0025

# Эффективная стоимость кеша
# Уже установлено выше
# effective_cache_size = 6GB


# -----------------------------
# ДРУГИЕ НАСТРОЙКИ
# -----------------------------

# Формат вывода даты
datestyle = 'iso, dmy'

# Стиль интервала
intervalstyle = 'postgres'

# Включить автоматический ANALYZE после COPY
default_statistics_target = 100
