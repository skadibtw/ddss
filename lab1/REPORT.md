# Отчёт по лабораторной работе №1 (PostgreSQL)

## 1. Цель работы

Развернуть отдельный кластер PostgreSQL, настроить параметры сервера, создать БД, роль, табличные пространства, прикладную схему с партиционированием, наполнить данными и выполнить проверку результата.

## 2. Состав проекта

- `scripts/create.sh` — полный сценарий развертывания и проверки.
- `scripts/setup.sql` — создание БД/роли/tablespace, схемы и тестовых данных.
- `scripts/check.sql` — контрольная проверка параметров и структуры.
- `scripts/clean.sh` — очистка кластера и служебных директорий.

## 3. Команды выполнения

Переход в каталог лабораторной:

```bash
cd /Users/skadibtw/ddss/lab1
```

Полный запуск с очисткой:

```bash
bash scripts/create.sh --reset
```

Повторный запуск без удаления кластера:

```bash
bash scripts/create.sh
```

Отдельная проверка:

```bash
psql -v ON_ERROR_STOP=1 -p 9099 -d postgres -f scripts/check.sql
```

Полная очистка:

```bash
bash scripts/clean.sh --yes
```

## 4. Порядок выполнения (по шагам `create.sh`)

1. `STEP 0` (опционально, `--reset`): остановка кластера и удаление директорий  
   Удаляются:
   - `$HOME/nwc36` (кластер)
   - `$HOME/sbm10` (tablespace 1)
   - `$HOME/nym69` (tablespace 2)
   - `/tmp/archive` (архив WAL)

2. `STEP 1`: подготовка директорий  
   Выполняется `mkdir -p` для директорий tablespace и архива, затем `chmod 700` для ограничения доступа.

3. `STEP 2`: `initdb` (если кластера нет)  
   Создаётся новый кластер в `$HOME/nwc36` с локалью `ru_RU.UTF-8`, кодировкой `UTF8`, checksum и параметрами аутентификации.

4. `STEP 3`: старт инстанса на порту `9099`  
   Кластер запускается через `pg_ctl`, далее готовность проверяется `pg_isready`.

5. `STEP 4`: настройка `postgresql.conf` через `ALTER SYSTEM`  
   Устанавливаются сетевые, memory, WAL, logging и locale/timezone параметры.

6. `STEP 5`: запись `pg_hba.conf`  
   Локальные подключения (`local`) — `peer`, TCP на localhost — `scram-sha-256`, внешние адреса — `reject`.

7. `STEP 6`: перезапуск кластера  
   Применение настроек, повторная проверка готовности.

8. `STEP 7`: запуск `setup.sql`  
   Создание БД, роли, tablespace, таблиц, индексов, партиций и заполнение данными.

9. `STEP 8`: запуск `check.sql`  
   Верификация параметров сервера, tablespace, распределения объектов и количества строк.

## 5. Что делает `setup.sql`

1. Включает останов при ошибке: `\set ON_ERROR_STOP on`.
2. Создаёт БД `bigbluecity` (если её нет) с `OWNER current_user`.
3. Создаёт роль `dbuser` (если её нет), задаёт пароль и срок действия.
4. Выдаёт `dbuser` доступ к БД `bigbluecity` и `postgres`.
5. Создаёт табличные пространства:
   - `sbm10_space` в `$HOME/sbm10`
   - `nym69_space` в `$HOME/nym69`
6. Выдаёт роль `dbuser` право `CREATE` на оба tablespace.
7. Подключается к `bigbluecity`, выдаёт права на `public`, переключается в `SET ROLE dbuser`.
8. Создаёт таблицы `customers`, `products`, `stores`, `sales`.
9. Настраивает RANGE-партиционирование таблицы `sales` по кварталам 2024 года.
10. Создаёт индексы с размещением в разных tablespace.
11. Загружает тестовые данные и 3000 строк в `sales`.
12. Пересоздаёт материализованное представление `sales_summary` и индекс на нём.

Примечание: сообщение  
`NOTICE: materialized view "sales_summary" does not exist, skipping`  
при первом запуске является нормальным, потому что используется `DROP MATERIALIZED VIEW IF EXISTS`.

## 6. Что проверяет `check.sql`

1. Таблица `pg_settings` для ключевых параметров:
   - `port`
   - `max_connections`
   - `shared_buffers`
   - `temp_buffers`
   - `work_mem`
   - `checkpoint_timeout`
   - `effective_cache_size`
   - `fsync`
   - `commit_delay`
   - `log_min_messages`
   - `log_connections`
   - `log_disconnections`
2. Наличие и параметры tablespace (имя, владелец, путь).
3. Размещение объектов схемы `public` по tablespace.
4. Количество строк в ключевых таблицах.
5. Фактическое распределение строк `sales` по партициям.

## 7. Обоснование выбранных параметров

### 7.1 Параметры инициализации кластера (`initdb`)

- `--encoding=UTF8`  
  Нужен для корректного хранения русскоязычных данных.

- `--locale=ru_RU.UTF-8` и `--lc-* ru_RU.UTF-8`  
  Единый формат сортировки, дат/времени, чисел, денежных значений и текстов сообщений.

- `--data-checksums`  
  Позволяет обнаруживать повреждение страниц данных.

- `--auth=peer`  
  Удобное и безопасное локальное подключение без пароля для текущего пользователя ОС.

- `--auth-host=scram-sha-256`  
  Современный безопасный способ аутентификации для TCP-подключений.

### 7.2 Сетевые параметры

- `port = 9099`  
  Изоляция от стандартного порта `5432` и возможных конфликтов.

- `listen_addresses = 'localhost'`  
  Доступ только с локальной машины (без внешней сети).

- `unix_socket_directories = '/tmp'`  
  Стандартный путь сокета, удобный для локального `psql`.

### 7.3 Память и производительность

- `max_connections = 300`  
  Демонстрация настройки под многопользовательский режим.

- `shared_buffers = 1GB`  
  Основной кэш PostgreSQL для уменьшения дискового I/O.

- `temp_buffers = 16MB`, `work_mem = 4MB`  
  Баланс между памятью и стабильностью при нескольких сессиях.

- `checkpoint_timeout = 10min`  
  Снижает частоту checkpoint и пики записи на диск.

- `effective_cache_size = 3GB`  
  Подсказка планировщику о предполагаемом кэше ОС.

- `fsync = on`  
  Гарантия сохранности данных при сбоях.

- `commit_delay = 10`, `commit_siblings = 5`  
  Небольшая оптимизация групповой записи commit при конкурирующих транзакциях.

### 7.4 WAL и архивирование

- `wal_level = replica`  
  Достаточный уровень WAL для репликации и архивного восстановления.

- `synchronous_commit = on`  
  Подтверждение commit только после надёжной записи WAL.

- `min_wal_size = 1GB`, `max_wal_size = 4GB`  
  Контроль объёма WAL и частоты checkpoint.

- `archive_mode = on`  
  Включение архивации WAL-сегментов.

- `archive_command = 'test ! -f /tmp/archive/%f && cp %p /tmp/archive/%f'`  
  Простая и безопасная локальная схема архивирования без перезаписи.

- `archive_timeout = 300`  
  Ограничение максимальной задержки архивации (до 5 минут).

### 7.5 Логирование

- `logging_collector = on`, `log_destination = 'stderr'`, `log_directory = 'log'`  
  Централизованный сбор серверных логов.

- `log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'`  
  Удобная ротация по времени.

- `log_min_messages = 'notice'`  
  Достаточно подробный уровень для учебной отладки.

- `log_connections = on`, `log_disconnections = on`  
  Фиксация жизненного цикла подключений.

- `log_line_prefix = '%m [%p] user=%u db=%d app=%a client=%h '`  
  Контекст в каждой строке лога для диагностики.

### 7.6 Безопасность доступа (`pg_hba.conf`)

- `local all all peer`  
  Локальный доступ через пользователя ОС.

- `host all all 127.0.0.1/32 scram-sha-256` и `::1/128`  
  TCP-доступ только с localhost и только по паролю SCRAM.

- `host all all 0.0.0.0/0 reject` и `::/0 reject`  
  Явный запрет внешних подключений.

## 8. Итог

В результате работы развернут и настроен изолированный кластер PostgreSQL на порту `9099`, создана БД `bigbluecity`, роль `dbuser`, два табличных пространства, партиционированная схема и тестовые данные. Настройки сервера и структура подтверждаются скриптом `check.sql`.
